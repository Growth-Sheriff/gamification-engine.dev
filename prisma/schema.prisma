// Gamification Engine - Database Schema
// Shopify App for Spin Wheel, Scratch Card, Popup Games

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════
// SHOP (Tenant) - Her mağaza bir tenant
// ═══════════════════════════════════════════════════════════════════════════
model Shop {
  id            String    @id @default(cuid())
  domain        String    @unique                    // xxx.myshopify.com
  accessToken   String
  name          String?
  email         String?
  isActive      Boolean   @default(true)

  // İlişkiler
  games         Game[]
  rules         DiscountRule[]
  discounts     Discount[]
  visitors      Visitor[]
  loyaltyProgram    LoyaltyProgram?
  referralProgram   ReferralProgram?
  emailIntegration  EmailIntegration?
  abTests           ABTest[]
  targetingRules    TargetingRule[]
  analytics         Analytics[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([domain])
  @@map("shops")
}

// ═══════════════════════════════════════════════════════════════════════════
// GAME (Oyunlar: Spin Wheel, Scratch Card, Popup)
// ═══════════════════════════════════════════════════════════════════════════
model Game {
  id            String      @id @default(cuid())
  shopId        String
  shop          Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  type          GameType                              // SPIN_WHEEL, SCRATCH_CARD, POPUP
  name          String
  isActive      Boolean     @default(false)

  // Görünüm ayarları (JSON)
  // { title, subtitle, buttonText, colors, styles... }
  config        Json        @default("{}")

  // Zamanlama
  startDate     DateTime?
  endDate       DateTime?

  // Tetikleyici
  trigger       TriggerType @default(TIME_ON_PAGE)
  triggerValue  Int         @default(3000)            // ms veya % (scroll için)

  // Hedefleme (boş = tüm sayfalar)
  showOnPages   String[]    @default([])

  // İlişkiler
  segments      GameSegment[]
  rules         DiscountRule[]
  plays         Play[]
  targetingRules TargetingRule[]
  abTests       ABTest[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([shopId, isActive])
  @@map("games")
}

enum GameType {
  SPIN_WHEEL
  SCRATCH_CARD
  POPUP
}

enum TriggerType {
  PAGE_LOAD
  TIME_ON_PAGE
  SCROLL_DEPTH
  EXIT_INTENT
}

// ═══════════════════════════════════════════════════════════════════════════
// GAME SEGMENT (Çark dilimleri, kazı kazan alanları, popup seçenekleri)
// ═══════════════════════════════════════════════════════════════════════════
model GameSegment {
  id            String    @id @default(cuid())
  gameId        String
  game          Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  label         String                                // "10% OFF", "Şanssız", "Free Shipping"
  type          PrizeType                             // PERCENTAGE, FIXED, FREE_SHIPPING, NO_PRIZE
  value         Float     @default(0)                 // 10, 5, 0
  probability   Float                                 // 0.25 = %25 olasılık
  color         String    @default("#7367F0")
  icon          String?                               // İkon (opsiyonel)

  order         Int       @default(0)                 // Sıralama

  @@index([gameId])
  @@map("game_segments")
}

enum PrizeType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  NO_PRIZE
}

// ═══════════════════════════════════════════════════════════════════════════
// DISCOUNT RULE (İndirim Kuralları - Detaylı Kontrol)
// ═══════════════════════════════════════════════════════════════════════════
model DiscountRule {
  id            String    @id @default(cuid())
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  gameId        String?
  game          Game?     @relation(fields: [gameId], references: [id], onDelete: SetNull)

  name          String
  isActive      Boolean   @default(true)

  // ═══ KULLANICI KISITLAMALARI ═══
  maxPlaysPerVisitor      Int       @default(1)       // Ziyaretçi başına maks oyun
  maxWinsPerVisitor       Int       @default(1)       // Ziyaretçi başına maks kazanç
  cooldownHours           Int       @default(24)      // Tekrar oynama bekleme (saat)
  requireEmail            Boolean   @default(false)   // Email zorunlu mu?

  // ═══ ÜRÜN KURALLARI ═══
  appliesTo               AppliesTo @default(ALL)
  productIds              String[]  @default([])      // Shopify product GIDs
  collectionIds           String[]  @default([])      // Shopify collection GIDs
  excludeProductIds       String[]  @default([])      // Hariç tutulan ürünler
  excludeSaleItems        Boolean   @default(false)   // İndirimli ürünler hariç

  // ═══ KULLANIM KURALLARI ═══
  maxTotalRedemptions     Int?                        // Toplam kullanım limiti (null = sınırsız)
  maxRedemptionsPerCode   Int       @default(1)       // Kod başına kullanım
  minOrderAmount          Float?                      // Minimum sepet tutarı
  maxDiscountAmount       Float?                      // Maksimum indirim tutarı

  // ═══ KOMBİNASYON KURALLARI ═══
  combineWithProductDiscount  Boolean @default(false)
  combineWithOrderDiscount    Boolean @default(false)
  combineWithShipping         Boolean @default(true)

  // ═══ GEÇERLİLİK ═══
  validityDays            Int       @default(7)       // Kodun geçerlilik süresi (gün)

  // İlişkiler
  discounts     Discount[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([shopId, isActive])
  @@map("discount_rules")
}

enum AppliesTo {
  ALL
  SPECIFIC_PRODUCTS
  SPECIFIC_COLLECTIONS
}

// ═══════════════════════════════════════════════════════════════════════════
// VISITOR (Ziyaretçi - Fingerprint bazlı, localStorage YOK)
// ═══════════════════════════════════════════════════════════════════════════
model Visitor {
  id            String    @id @default(cuid())
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  fingerprint   String                                // Browser fingerprint hash
  email         String?
  customerId    String?                               // Shopify customer GID

  // Metadata
  country       String?
  city          String?
  device        String?                               // mobile, desktop, tablet
  browser       String?
  os            String?

  // İstatistikler
  totalPlays    Int       @default(0)
  totalWins     Int       @default(0)

  firstVisit    DateTime  @default(now())
  lastVisit     DateTime  @default(now())

  // İlişkiler
  plays         Play[]
  discounts     Discount[]
  sessions      Session[]

  @@unique([shopId, fingerprint])
  @@index([shopId, fingerprint])
  @@index([shopId, email])
  @@map("visitors")
}

// ═══════════════════════════════════════════════════════════════════════════
// SESSION (Oturum - Veritabanı bazlı, sessionStorage YOK)
// ═══════════════════════════════════════════════════════════════════════════
model Session {
  id            String    @id @default(cuid())
  visitorId     String
  visitor       Visitor   @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  token         String    @unique                     // Frontend'e gönderilen token

  // Sayfa bilgileri
  currentPage   String?
  referrer      String?
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?

  // Durum
  isActive      Boolean   @default(true)

  startedAt     DateTime  @default(now())
  lastActivityAt DateTime @default(now())
  endedAt       DateTime?

  @@index([token])
  @@index([visitorId])
  @@map("sessions")
}

// ═══════════════════════════════════════════════════════════════════════════
// PLAY (Oyun oynama kaydı)
// ═══════════════════════════════════════════════════════════════════════════
model Play {
  id            String      @id @default(cuid())
  gameId        String
  game          Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)
  visitorId     String
  visitor       Visitor     @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  result        PlayResult                            // WIN, LOSE
  segmentId     String?                               // Kazanılan segment ID

  // Ödül detayları (JSON)
  // { type, value, label }
  prize         Json?

  // İndirim ilişkisi
  discountId    String?     @unique
  discount      Discount?   @relation(fields: [discountId], references: [id])

  playedAt      DateTime    @default(now())

  @@index([gameId, visitorId])
  @@index([visitorId, playedAt])
  @@map("plays")
}

enum PlayResult {
  WIN
  LOSE
}

// ═══════════════════════════════════════════════════════════════════════════
// DISCOUNT (Oluşturulan indirim kodları)
// ═══════════════════════════════════════════════════════════════════════════
model Discount {
  id              String          @id @default(cuid())
  shopId          String
  shop            Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  visitorId       String
  visitor         Visitor         @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  ruleId          String
  rule            DiscountRule    @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  code            String                              // SPIN10-XXXXX
  shopifyId       String?                             // Shopify discount node GID

  type            PrizeType
  value           Float

  status          DiscountStatus  @default(CREATED)

  // Kullanım bilgileri
  usedAt          DateTime?
  usedOrderId     String?                             // Shopify order GID
  usedOrderAmount Float?

  expiresAt       DateTime

  // İlişki
  play            Play?

  createdAt       DateTime        @default(now())

  @@unique([shopId, code])
  @@index([shopId, status])
  @@index([code])
  @@index([expiresAt])
  @@map("discounts")
}

enum DiscountStatus {
  CREATED     // Oluşturuldu, henüz kullanılmadı
  USED        // Kullanıldı
  EXPIRED     // Süresi doldu
}

// ═══════════════════════════════════════════════════════════════════════════
// ANALYTICS (Günlük istatistikler - Performans için)
// ═══════════════════════════════════════════════════════════════════════════
model Analytics {
  id            String    @id @default(cuid())
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  gameId        String?

  date          DateTime  @db.Date

  // Metrikler
  views         Int       @default(0)                 // Oyun görüntülenme
  plays         Int       @default(0)                 // Oyun oynanma
  wins          Int       @default(0)                 // Kazanma
  claims        Int       @default(0)                 // Kod alma
  redemptions   Int       @default(0)                 // Kod kullanma
  revenue       Float     @default(0)                 // Elde edilen gelir

  @@unique([shopId, gameId, date])
  @@index([shopId, date])
  @@map("analytics")
}

// ═══════════════════════════════════════════════════════════════════════════
// LOYALTY SYSTEM (Sadakat Puan Sistemi)
// ═══════════════════════════════════════════════════════════════════════════
model LoyaltyProgram {
  id            String    @id @default(cuid())
  shopId        String    @unique
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isActive      Boolean   @default(false)
  name          String    @default("Sadakat Programı")

  // Puan kazanma kuralları
  pointsPerPurchase       Float     @default(1)       // Harcanan TL başına puan
  pointsForSignup         Int       @default(100)     // Kayıt puanı
  pointsForBirthday       Int       @default(200)     // Doğum günü puanı
  pointsForReview         Int       @default(50)      // Yorum puanı
  pointsForReferral       Int       @default(500)     // Referans puanı
  pointsForSocialShare    Int       @default(25)      // Sosyal paylaşım puanı

  // Puan kullanma
  pointsPerDiscount       Int       @default(100)     // İndirim için gereken puan
  discountValue           Float     @default(10)      // Puan karşılığı TL
  minRedeemPoints         Int       @default(100)     // Minimum kullanım puanı

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tiers         LoyaltyTier[]

  @@map("loyalty_programs")
}

model LoyaltyTier {
  id            String    @id @default(cuid())
  programId     String
  program       LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  name          String                                // Bronze, Silver, Gold, Platinum
  minPoints     Int                                   // Bu seviye için gereken puan
  color         String    @default("#CD7F32")
  icon          String?

  // Avantajlar
  pointMultiplier         Float     @default(1)       // Puan çarpanı
  freeShipping            Boolean   @default(false)   // Ücretsiz kargo
  exclusiveAccess         Boolean   @default(false)   // Özel erişim
  birthdayBonus           Int       @default(0)       // Ekstra doğum günü puanı

  order         Int       @default(0)

  @@index([programId])
  @@map("loyalty_tiers")
}

model LoyaltyPoints {
  id            String    @id @default(cuid())
  visitorId     String
  shopId        String

  points        Int       @default(0)
  lifetimePoints Int      @default(0)                 // Toplam kazanılan puan
  currentTier   String?

  // Son aktivite
  lastEarnedAt  DateTime?
  lastRedeemedAt DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  transactions  PointTransaction[]

  @@unique([visitorId, shopId])
  @@index([shopId])
  @@map("loyalty_points")
}

model PointTransaction {
  id            String    @id @default(cuid())
  loyaltyId     String
  loyalty       LoyaltyPoints @relation(fields: [loyaltyId], references: [id], onDelete: Cascade)

  type          PointTransactionType
  points        Int                                   // Pozitif = kazanç, negatif = harcama
  description   String

  // İlişkili kayıt
  orderId       String?
  referralId    String?

  createdAt     DateTime  @default(now())

  @@index([loyaltyId])
  @@map("point_transactions")
}

enum PointTransactionType {
  PURCHASE          // Satın alma
  SIGNUP            // Kayıt
  BIRTHDAY          // Doğum günü
  REVIEW            // Yorum
  REFERRAL          // Referans
  SOCIAL_SHARE      // Sosyal paylaşım
  GAME_WIN          // Oyun kazanma
  REDEEM            // Kullanım
  EXPIRE            // Süre dolumu
  ADMIN_ADJUST      // Admin ayarlaması
}

// ═══════════════════════════════════════════════════════════════════════════
// A/B TESTING
// ═══════════════════════════════════════════════════════════════════════════
model ABTest {
  id            String    @id @default(cuid())
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  gameId        String?
  game          Game?     @relation(fields: [gameId], references: [id], onDelete: SetNull)

  name          String
  description   String?
  isActive      Boolean   @default(false)

  // Test parametreleri
  trafficSplit  Int       @default(50)                // % trafik bölünmesi

  startDate     DateTime?
  endDate       DateTime?

  // Sonuçlar
  winner        String?                               // Kazanan varyant ID

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  variants      ABTestVariant[]

  @@index([shopId, isActive])
  @@map("ab_tests")
}

model ABTestVariant {
  id            String    @id @default(cuid())
  testId        String
  test          ABTest    @relation(fields: [testId], references: [id], onDelete: Cascade)

  name          String                                // "Control", "Variant A", "Variant B"
  isControl     Boolean   @default(false)

  // Varyant ayarları (JSON)
  config        Json      @default("{}")

  // Metrikler
  impressions   Int       @default(0)
  plays         Int       @default(0)
  wins          Int       @default(0)
  conversions   Int       @default(0)
  revenue       Float     @default(0)

  @@index([testId])
  @@map("ab_test_variants")
}

// ═══════════════════════════════════════════════════════════════════════════
// TARGETING RULES (Gelişmiş Hedefleme)
// ═══════════════════════════════════════════════════════════════════════════
model TargetingRule {
  id            String    @id @default(cuid())
  shopId        String
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  gameId        String
  game          Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  name          String
  isActive      Boolean   @default(true)
  priority      Int       @default(0)                 // Yüksek = öncelikli

  // Sayfa hedefleme
  pageType      String[]  @default([])                // index, product, collection, cart
  pageUrls      String[]  @default([])                // Spesifik URL'ler
  excludeUrls   String[]  @default([])                // Hariç tutulan URL'ler

  // Cihaz hedefleme
  devices       String[]  @default([])                // mobile, desktop, tablet

  // Ziyaretçi hedefleme
  visitorType   VisitorTargetType @default(ALL)

  // Trafik kaynağı
  trafficSource String[]  @default([])                // direct, organic, paid, social, email
  utmSource     String[]  @default([])
  utmMedium     String[]  @default([])
  utmCampaign   String[]  @default([])

  // Coğrafi hedefleme
  countries     String[]  @default([])
  cities        String[]  @default([])

  // Sepet hedefleme
  minCartValue  Float?
  maxCartValue  Float?
  minCartItems  Int?
  maxCartItems  Int?
  cartContains  String[]  @default([])                // Ürün ID'leri
  cartNotContains String[] @default([])

  // Zaman hedefleme
  scheduleEnabled Boolean  @default(false)
  scheduleDays    Int[]   @default([])                // 0=Pazar, 1=Pazartesi...
  scheduleStartHour Int?
  scheduleEndHour   Int?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([shopId, gameId, isActive])
  @@map("targeting_rules")
}

enum VisitorTargetType {
  ALL                    // Tüm ziyaretçiler
  NEW                    // Yeni ziyaretçiler
  RETURNING              // Geri dönen ziyaretçiler
  CUSTOMERS              // Müşteriler
  NON_CUSTOMERS          // Müşteri olmayanlar
  LOGGED_IN              // Giriş yapmış
  NOT_LOGGED_IN          // Giriş yapmamış
}

// ═══════════════════════════════════════════════════════════════════════════
// REFERRAL SYSTEM (Arkadaş Getir)
// ═══════════════════════════════════════════════════════════════════════════
model ReferralProgram {
  id            String    @id @default(cuid())
  shopId        String    @unique
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  isActive      Boolean   @default(false)

  // Ödüller
  referrerReward      String    @default("DISCOUNT")  // DISCOUNT, POINTS
  referrerValue       Float     @default(10)          // TL veya puan
  refereeReward       String    @default("DISCOUNT")
  refereeValue        Float     @default(10)

  // Koşullar
  requirePurchase     Boolean   @default(true)        // Davet edilen satın almalı mı?
  minPurchaseAmount   Float?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  referrals     Referral[]

  @@map("referral_programs")
}

model Referral {
  id            String    @id @default(cuid())
  programId     String
  program       ReferralProgram @relation(fields: [programId], references: [id], onDelete: Cascade)

  referrerVisitorId String
  refereeVisitorId  String?

  code          String    @unique

  status        ReferralStatus @default(PENDING)

  // Ödül bilgileri
  referrerRewarded Boolean @default(false)
  refereeRewarded  Boolean @default(false)

  // İlişkili siparişler
  refereeOrderId    String?
  refereeOrderAmount Float?

  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  @@index([programId])
  @@index([referrerVisitorId])
  @@index([code])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING       // Bekliyor
  COMPLETED     // Tamamlandı
  EXPIRED       // Süresi doldu
}

// ═══════════════════════════════════════════════════════════════════════════
// EMAIL INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════
model EmailIntegration {
  id            String    @id @default(cuid())
  shopId        String    @unique
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  provider      EmailProvider @default(NONE)
  apiKey        String?
  listId        String?

  // Otomatik emailler
  sendWinEmail          Boolean   @default(true)
  sendReminderEmail     Boolean   @default(true)
  sendExpiryEmail       Boolean   @default(true)

  reminderHours         Int       @default(24)        // Hatırlatma süresi

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("email_integrations")
}

enum EmailProvider {
  NONE
  KLAVIYO
  MAILCHIMP
  OMNISEND
  SENDGRID
}


