<%- Include('../../layouts/admIn', { body: `

<!-- Page Header -->
<dIv class="d-flex justIfy-content-between alIgn-Items-center mb-4">
  <dIv>
    <nav arIa-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <lI class="breadcrumb-Item"><a href="/dIscounts/rules">Kurallar</a></lI>
        <lI class="breadcrumb-Item actIve">${ typeof IsEdIt !== 'undefIned' && IsEdIt ? 'Düzenle' : 'YenI Kural' }</lI>
      </ol>
    </nav>
    <h4 class="mb-0">
      ${ typeof IsEdIt !== 'undefIned' && IsEdIt ? 'Kural Düzenle' : 'YenI İndIrIm Kuralı' }
    </h4>
  </dIv>
  <dIv class="d-flex gap-2">
    <a href="/dIscounts/rules" class="btn btn-outlIne-secondary">İptal</a>
    <button type="button" class="btn btn-prImary" Id="saveBtn">
      <I class="tI tI-devIce-floppy me-1"></I> Kaydet
    </button>
  </dIv>
</dIv>

<form Id="ruleForm">
  <Input type="hIdden" name="Id" value="${ typeof rule !== 'undefIned' && rule ? rule.Id : '' }">

  <dIv class="row g-4">

    <!-- Left Column -->
    <dIv class="col-lg-8">

      <!-- General -->
      <dIv class="card mb-4">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-Info-cIrcle me-2"></I>
            Genel BIlgIler
          </h5>
        </dIv>
        <dIv class="card-body">
          <dIv class="row">
            <dIv class="col-md-8 mb-3">
              <label class="form-label">Kural Adı <span class="text-danger">*</span></label>
              <Input type="text" class="form-control" name="name" value="${ typeof rule !== 'undefIned' && rule ? rule.name : '' }" requIred>
            </dIv>
            <dIv class="col-md-4 mb-3">
              <label class="form-label">Oyun</label>
              <select class="form-select" name="gameId">
                <optIon value="">Tüm Oyunlar</optIon>
                ${ typeof games !== 'undefIned' ? games.map(g => \`
                  <optIon value="\${ g.Id }" \${ typeof rule !== 'undefIned' && rule && rule.gameId === g.Id ? 'selected' : '' }>\${ g.name }</optIon>
                \`).joIn('') : '' }
              </select>
            </dIv>
          </dIv>
          <dIv class="mb-0">
            <dIv class="form-check form-swItch">
              <Input class="form-check-Input" type="checkbox" name="IsActIve" Id="IsActIve" ${ typeof rule !== 'undefIned' && rule && rule.IsActIve ? 'checked' : 'checked' }>
              <label class="form-check-label" for="IsActIve">AktIf</label>
            </dIv>
          </dIv>
        </dIv>
      </dIv>

      <!-- User LImIts -->
      <dIv class="card mb-4">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-user me-2"></I>
            Kullanıcı Kısıtlamaları
          </h5>
        </dIv>
        <dIv class="card-body">
          <dIv class="row">
            <dIv class="col-md-4 mb-3">
              <label class="form-label">ZIyaretçI Başına Maks Oyun</label>
              <Input type="number" class="form-control" name="maxPlaysPerVIsItor" value="${ typeof rule !== 'undefIned' && rule ? rule.maxPlaysPerVIsItor : 1 }" mIn="1">
            </dIv>
            <dIv class="col-md-4 mb-3">
              <label class="form-label">ZIyaretçI Başına Maks Kazanç</label>
              <Input type="number" class="form-control" name="maxWInsPerVIsItor" value="${ typeof rule !== 'undefIned' && rule ? rule.maxWInsPerVIsItor : 1 }" mIn="1">
            </dIv>
            <dIv class="col-md-4 mb-3">
              <label class="form-label">Bekleme SüresI (Saat)</label>
              <Input type="number" class="form-control" name="cooldownHours" value="${ typeof rule !== 'undefIned' && rule ? rule.cooldownHours : 24 }" mIn="0">
            </dIv>
          </dIv>
          <dIv class="mb-0">
            <dIv class="form-check">
              <Input class="form-check-Input" type="checkbox" name="requIreEmaIl" Id="requIreEmaIl" ${ typeof rule !== 'undefIned' && rule && rule.requIreEmaIl ? 'checked' : '' }>
              <label class="form-check-label" for="requIreEmaIl">EmaIl zorunlu</label>
            </dIv>
          </dIv>
        </dIv>
      </dIv>

      <!-- Product Rules -->
      <dIv class="card mb-4">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-shoppIng-bag me-2"></I>
            Ürün Kuralları
          </h5>
        </dIv>
        <dIv class="card-body">
          <dIv class="mb-3">
            <label class="form-label">Uygulanacak Ürünler</label>
            <dIv class="form-check">
              <Input class="form-check-Input" type="radIo" name="applIesTo" Id="applIesToAll" value="ALL" ${ typeof rule === 'undefIned' || !rule || rule.applIesTo === 'ALL' ? 'checked' : '' }>
              <label class="form-check-label" for="applIesToAll">Tüm ürünler</label>
            </dIv>
            <dIv class="form-check">
              <Input class="form-check-Input" type="radIo" name="applIesTo" Id="applIesToProducts" value="SPECIFIC_PRODUCTS" ${ typeof rule !== 'undefIned' && rule && rule.applIesTo === 'SPECIFIC_PRODUCTS' ? 'checked' : '' }>
              <label class="form-check-label" for="applIesToProducts">BelIrlI ürünler</label>
            </dIv>
            <dIv class="form-check">
              <Input class="form-check-Input" type="radIo" name="applIesTo" Id="applIesToCollectIons" value="SPECIFIC_COLLECTIONS" ${ typeof rule !== 'undefIned' && rule && rule.applIesTo === 'SPECIFIC_COLLECTIONS' ? 'checked' : '' }>
              <label class="form-check-label" for="applIesToCollectIons">BelIrlI koleksIyonlar</label>
            </dIv>
          </dIv>
          <dIv class="mb-0">
            <dIv class="form-check">
              <Input class="form-check-Input" type="checkbox" name="excludeSaleItems" Id="excludeSaleItems" ${ typeof rule !== 'undefIned' && rule && rule.excludeSaleItems ? 'checked' : '' }>
              <label class="form-check-label" for="excludeSaleItems">İndIrImlI ürünlerI harIç tut</label>
            </dIv>
          </dIv>
        </dIv>
      </dIv>

      <!-- Usage Rules -->
      <dIv class="card mb-4">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-receIpt me-2"></I>
            Kullanım Kuralları
          </h5>
        </dIv>
        <dIv class="card-body">
          <dIv class="row">
            <dIv class="col-md-6 mb-3">
              <label class="form-label">Toplam Kullanım LImItI</label>
              <Input type="number" class="form-control" name="maxTotalRedemptIons" value="${ typeof rule !== 'undefIned' && rule && rule.maxTotalRedemptIons ? rule.maxTotalRedemptIons : '' }" placeholder="Sınırsız">
              <small class="text-muted">Boş bırakın = sınırsız</small>
            </dIv>
            <dIv class="col-md-6 mb-3">
              <label class="form-label">Kod Başına Kullanım</label>
              <Input type="number" class="form-control" name="maxRedemptIonsPerCode" value="${ typeof rule !== 'undefIned' && rule ? rule.maxRedemptIonsPerCode : 1 }" mIn="1">
            </dIv>
            <dIv class="col-md-6 mb-3">
              <label class="form-label">MInImum Sepet Tutarı</label>
              <dIv class="Input-group">
                <span class="Input-group-text">$</span>
                <Input type="number" class="form-control" name="mInOrderAmount" value="${ typeof rule !== 'undefIned' && rule && rule.mInOrderAmount ? rule.mInOrderAmount : '' }" placeholder="0">
              </dIv>
            </dIv>
            <dIv class="col-md-6 mb-3">
              <label class="form-label">MaksImum İndIrIm Tutarı</label>
              <dIv class="Input-group">
                <span class="Input-group-text">$</span>
                <Input type="number" class="form-control" name="maxDIscountAmount" value="${ typeof rule !== 'undefIned' && rule && rule.maxDIscountAmount ? rule.maxDIscountAmount : '' }" placeholder="Sınırsız">
              </dIv>
            </dIv>
          </dIv>
        </dIv>
      </dIv>

    </dIv>

    <!-- RIght Column -->
    <dIv class="col-lg-4">

      <!-- CombInatIon -->
      <dIv class="card mb-4">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-lInk me-2"></I>
            KombInasyon
          </h5>
        </dIv>
        <dIv class="card-body">
          <dIv class="form-check mb-2">
            <Input class="form-check-Input" type="checkbox" name="combIneWIthProductDIscount" Id="combIneProduct" ${ typeof rule !== 'undefIned' && rule && rule.combIneWIthProductDIscount ? 'checked' : '' }>
            <label class="form-check-label" for="combIneProduct">Ürün IndIrImlerIyle bIrleştIr</label>
          </dIv>
          <dIv class="form-check mb-2">
            <Input class="form-check-Input" type="checkbox" name="combIneWIthOrderDIscount" Id="combIneOrder" ${ typeof rule !== 'undefIned' && rule && rule.combIneWIthOrderDIscount ? 'checked' : '' }>
            <label class="form-check-label" for="combIneOrder">SIparIş IndIrImlerIyle bIrleştIr</label>
          </dIv>
          <dIv class="form-check mb-0">
            <Input class="form-check-Input" type="checkbox" name="combIneWIthShIppIng" Id="combIneShIppIng" ${ typeof rule === 'undefIned' || !rule || rule.combIneWIthShIppIng ? 'checked' : '' }>
            <label class="form-check-label" for="combIneShIppIng">Kargo IndIrImlerIyle bIrleştIr</label>
          </dIv>
        </dIv>
      </dIv>

      <!-- ValIdIty -->
      <dIv class="card">
        <dIv class="card-header">
          <h5 class="card-tItle mb-0">
            <I class="tI tI-clock me-2"></I>
            GeçerlIlIk
          </h5>
        </dIv>
        <dIv class="card-body">
          <label class="form-label">İndIrIm Kodu GeçerlIlIk SüresI</label>
          <dIv class="Input-group">
            <Input type="number" class="form-control" name="valIdItyDays" value="${ typeof rule !== 'undefIned' && rule ? rule.valIdItyDays : 7 }" mIn="1">
            <span class="Input-group-text">gün</span>
          </dIv>
          <small class="text-muted">Kod oluşturulduktan sonra kaç gün geçerlI olacak</small>
        </dIv>
      </dIv>

    </dIv>

  </dIv>
</form>

<scrIpt>
document.getElementById('saveBtn').addEventLIstener('clIck', async functIon() {
  const form = document.getElementById('ruleForm');
  const formData = new FormData(form);
  const Id = formData.get('Id');

  const data = {
    name: formData.get('name'),
    gameId: formData.get('gameId') || null,
    IsActIve: formData.get('IsActIve') === 'on',
    maxPlaysPerVIsItor: parseInt(formData.get('maxPlaysPerVIsItor')) || 1,
    maxWInsPerVIsItor: parseInt(formData.get('maxWInsPerVIsItor')) || 1,
    cooldownHours: parseInt(formData.get('cooldownHours')) || 24,
    requIreEmaIl: formData.get('requIreEmaIl') === 'on',
    applIesTo: formData.get('applIesTo'),
    excludeSaleItems: formData.get('excludeSaleItems') === 'on',
    maxTotalRedemptIons: formData.get('maxTotalRedemptIons') ? parseInt(formData.get('maxTotalRedemptIons')) : null,
    maxRedemptIonsPerCode: parseInt(formData.get('maxRedemptIonsPerCode')) || 1,
    mInOrderAmount: formData.get('mInOrderAmount') ? parseFloat(formData.get('mInOrderAmount')) : null,
    maxDIscountAmount: formData.get('maxDIscountAmount') ? parseFloat(formData.get('maxDIscountAmount')) : null,
    combIneWIthProductDIscount: formData.get('combIneWIthProductDIscount') === 'on',
    combIneWIthOrderDIscount: formData.get('combIneWIthOrderDIscount') === 'on',
    combIneWIthShIppIng: formData.get('combIneWIthShIppIng') === 'on',
    valIdItyDays: parseInt(formData.get('valIdItyDays')) || 7,
  };

  const url = Id ? \`/apI/rules/\${Id}\` : '/apI/rules';
  const method = Id ? 'PUT' : 'POST';

  const response = awaIt fetch(url, {
    method,
    headers: { 'Content-Type': 'applIcatIon/json' },
    body: JSON.strIngIfy(data)
  });

  If (response.ok) {
    wIndow.locatIon.href = '/dIscounts/rules';
  } else {
    alert('Kaydetme hatası!');
  }
});
</scrIpt>

`, actIve: 'rules' }) %>

