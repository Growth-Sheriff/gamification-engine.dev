<%- include('../../layouts/admin', { body: `

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-1">
        <li class="breadcrumb-item"><a href="/discounts/rules">Kurallar</a></li>
        <li class="breadcrumb-item active">${ typeof isEdit !== 'undefined' && isEdit ? 'Düzenle' : 'Yeni Kural' }</li>
      </ol>
    </nav>
    <h4 class="mb-0">
      ${ typeof isEdit !== 'undefined' && isEdit ? 'Kural Düzenle' : 'Yeni İndirim Kuralı' }
    </h4>
  </div>
  <div class="d-flex gap-2">
    <a href="/discounts/rules" class="btn btn-outline-secondary">İptal</a>
    <button type="button" class="btn btn-primary" id="saveBtn">
      <i class="ti ti-device-floppy me-1"></i> Kaydet
    </button>
  </div>
</div>

<form id="ruleForm">
  <input type="hidden" name="id" value="${ typeof rule !== 'undefined' && rule ? rule.id : '' }">

  <div class="row g-4">

    <!-- Left Column -->
    <div class="col-lg-8">

      <!-- General -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-info-circle me-2"></i>
            Genel Bilgiler
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8 mb-3">
              <label class="form-label">Kural Adı <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="name" value="${ typeof rule !== 'undefined' && rule ? rule.name : '' }" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Oyun</label>
              <select class="form-select" name="gameId">
                <option value="">Tüm Oyunlar</option>
                ${ typeof games !== 'undefined' ? games.map(g => \`
                  <option value="\${ g.id }" \${ typeof rule !== 'undefined' && rule && rule.gameId === g.id ? 'selected' : '' }>\${ g.name }</option>
                \`).join('') : '' }
              </select>
            </div>
          </div>
          <div class="mb-0">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" name="isActive" id="isActive" ${ typeof rule !== 'undefined' && rule && rule.isActive ? 'checked' : 'checked' }>
              <label class="form-check-label" for="isActive">Aktif</label>
            </div>
          </div>
        </div>
      </div>

      <!-- User Limits -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-user me-2"></i>
            Kullanıcı Kısıtlamaları
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Ziyaretçi Başına Maks Oyun</label>
              <input type="number" class="form-control" name="maxPlaysPerVisitor" value="${ typeof rule !== 'undefined' && rule ? rule.maxPlaysPerVisitor : 1 }" min="1">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Ziyaretçi Başına Maks Kazanç</label>
              <input type="number" class="form-control" name="maxWinsPerVisitor" value="${ typeof rule !== 'undefined' && rule ? rule.maxWinsPerVisitor : 1 }" min="1">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Bekleme Süresi (Saat)</label>
              <input type="number" class="form-control" name="cooldownHours" value="${ typeof rule !== 'undefined' && rule ? rule.cooldownHours : 24 }" min="0">
            </div>
          </div>
          <div class="mb-0">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="requireEmail" id="requireEmail" ${ typeof rule !== 'undefined' && rule && rule.requireEmail ? 'checked' : '' }>
              <label class="form-check-label" for="requireEmail">Email zorunlu</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Rules -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-shopping-bag me-2"></i>
            Ürün Kuralları
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Uygulanacak Ürünler</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="appliesTo" id="appliesToAll" value="ALL" ${ typeof rule === 'undefined' || !rule || rule.appliesTo === 'ALL' ? 'checked' : '' }>
              <label class="form-check-label" for="appliesToAll">Tüm ürünler</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="appliesTo" id="appliesToProducts" value="SPECIFIC_PRODUCTS" ${ typeof rule !== 'undefined' && rule && rule.appliesTo === 'SPECIFIC_PRODUCTS' ? 'checked' : '' }>
              <label class="form-check-label" for="appliesToProducts">Belirli ürünler</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="appliesTo" id="appliesToCollections" value="SPECIFIC_COLLECTIONS" ${ typeof rule !== 'undefined' && rule && rule.appliesTo === 'SPECIFIC_COLLECTIONS' ? 'checked' : '' }>
              <label class="form-check-label" for="appliesToCollections">Belirli koleksiyonlar</label>
            </div>
          </div>
          <div class="mb-0">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="excludeSaleItems" id="excludeSaleItems" ${ typeof rule !== 'undefined' && rule && rule.excludeSaleItems ? 'checked' : '' }>
              <label class="form-check-label" for="excludeSaleItems">İndirimli ürünleri hariç tut</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Usage Rules -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-receipt me-2"></i>
            Kullanım Kuralları
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Toplam Kullanım Limiti</label>
              <input type="number" class="form-control" name="maxTotalRedemptions" value="${ typeof rule !== 'undefined' && rule && rule.maxTotalRedemptions ? rule.maxTotalRedemptions : '' }" placeholder="Sınırsız">
              <small class="text-muted">Boş bırakın = sınırsız</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Kod Başına Kullanım</label>
              <input type="number" class="form-control" name="maxRedemptionsPerCode" value="${ typeof rule !== 'undefined' && rule ? rule.maxRedemptionsPerCode : 1 }" min="1">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Minimum Sepet Tutarı</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" name="minOrderAmount" value="${ typeof rule !== 'undefined' && rule && rule.minOrderAmount ? rule.minOrderAmount : '' }" placeholder="0">
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Maksimum İndirim Tutarı</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" name="maxDiscountAmount" value="${ typeof rule !== 'undefined' && rule && rule.maxDiscountAmount ? rule.maxDiscountAmount : '' }" placeholder="Sınırsız">
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column -->
    <div class="col-lg-4">

      <!-- Combination -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-link me-2"></i>
            Kombinasyon
          </h5>
        </div>
        <div class="card-body">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="combineWithProductDiscount" id="combineProduct" ${ typeof rule !== 'undefined' && rule && rule.combineWithProductDiscount ? 'checked' : '' }>
            <label class="form-check-label" for="combineProduct">Ürün indirimleriyle birleştir</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="combineWithOrderDiscount" id="combineOrder" ${ typeof rule !== 'undefined' && rule && rule.combineWithOrderDiscount ? 'checked' : '' }>
            <label class="form-check-label" for="combineOrder">Sipariş indirimleriyle birleştir</label>
          </div>
          <div class="form-check mb-0">
            <input class="form-check-input" type="checkbox" name="combineWithShipping" id="combineShipping" ${ typeof rule === 'undefined' || !rule || rule.combineWithShipping ? 'checked' : '' }>
            <label class="form-check-label" for="combineShipping">Kargo indirimleriyle birleştir</label>
          </div>
        </div>
      </div>

      <!-- Validity -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ti ti-clock me-2"></i>
            Geçerlilik
          </h5>
        </div>
        <div class="card-body">
          <label class="form-label">İndirim Kodu Geçerlilik Süresi</label>
          <div class="input-group">
            <input type="number" class="form-control" name="validityDays" value="${ typeof rule !== 'undefined' && rule ? rule.validityDays : 7 }" min="1">
            <span class="input-group-text">gün</span>
          </div>
          <small class="text-muted">Kod oluşturulduktan sonra kaç gün geçerli olacak</small>
        </div>
      </div>

    </div>

  </div>
</form>

<script>
document.getElementById('saveBtn').addEventListener('click', async function() {
  const form = document.getElementById('ruleForm');
  const formData = new FormData(form);
  const id = formData.get('id');

  const data = {
    name: formData.get('name'),
    gameId: formData.get('gameId') || null,
    isActive: formData.get('isActive') === 'on',
    maxPlaysPerVisitor: parseInt(formData.get('maxPlaysPerVisitor')) || 1,
    maxWinsPerVisitor: parseInt(formData.get('maxWinsPerVisitor')) || 1,
    cooldownHours: parseInt(formData.get('cooldownHours')) || 24,
    requireEmail: formData.get('requireEmail') === 'on',
    appliesTo: formData.get('appliesTo'),
    excludeSaleItems: formData.get('excludeSaleItems') === 'on',
    maxTotalRedemptions: formData.get('maxTotalRedemptions') ? parseInt(formData.get('maxTotalRedemptions')) : null,
    maxRedemptionsPerCode: parseInt(formData.get('maxRedemptionsPerCode')) || 1,
    minOrderAmount: formData.get('minOrderAmount') ? parseFloat(formData.get('minOrderAmount')) : null,
    maxDiscountAmount: formData.get('maxDiscountAmount') ? parseFloat(formData.get('maxDiscountAmount')) : null,
    combineWithProductDiscount: formData.get('combineWithProductDiscount') === 'on',
    combineWithOrderDiscount: formData.get('combineWithOrderDiscount') === 'on',
    combineWithShipping: formData.get('combineWithShipping') === 'on',
    validityDays: parseInt(formData.get('validityDays')) || 7,
  };

  const url = id ? \`/api/rules/\${id}\` : '/api/rules';
  const method = id ? 'PUT' : 'POST';

  const response = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (response.ok) {
    window.location.href = '/discounts/rules';
  } else {
    alert('Kaydetme hatası!');
  }
});
</script>

`, active: 'rules' }) %>

