<!DOCTYPE html>
<html lang="en" class="light-style layout-navbar-fixed layout-menu-fixed" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Popup - Gamification Engine</title>
  <link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css" />
  <link rel="stylesheet" href="/assets/css/core.css" />
  <style>
    .popup-preview {
      width: 320px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 40px 30px;
      text-align: center;
      color: white;
      box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
      position: relative;
    }
    .popup-emoji { font-size: 4rem; margin-bottom: 15px; }
    .popup-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
    .popup-subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 20px; }
    .popup-discount { font-size: 3rem; font-weight: 900; margin-bottom: 20px; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .popup-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 40px;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .popup-btn:hover { transform: scale(1.05); }
    .popup-close { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; width: 30px; height: 30px; border-radius: 50%; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <%- include('../../partials/sidebar', { active: 'popup' }) %>
      <div class="layout-page">
        <%- include('../../partials/navbar') %>
        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h4 class="mb-1"><i class="ti ti-window me-2"></i>Popup</h4>
                <p class="text-muted mb-0">Indirim popup ayarlari</p>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveGame()">
                  <i class="ti ti-device-floppy me-1"></i>Kaydet
                </button>
              </div>
            </div>

            <div class="row g-4">
              <!-- Sol Panel: Ayarlar -->
              <div class="col-lg-7">
                <!-- Genel Ayarlar -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="ti ti-settings me-2"></i>Genel Ayarlar</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-8">
                        <label class="form-label">Oyun Adi</label>
                        <input type="text" class="form-control" id="gameName" value="<%= typeof game !== 'undefined' && game ? game.name : 'Indirim Popup' %>">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">Durum</label>
                        <div class="form-check form-switch mt-2">
                          <input class="form-check-input" type="checkbox" id="gameActive" <%= typeof game !== 'undefined' && game && game.isActive ? 'checked' : '' %>>
                          <label class="form-check-label" for="gameActive">Aktif</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tetikleyici -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="ti ti-click me-2"></i>Tetikleyici</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Tetikleme Tipi</label>
                        <select class="form-select" id="triggerType">
                          <option value="EXIT_INTENT" <%= typeof game !== 'undefined' && game && game.trigger === 'EXIT_INTENT' ? 'selected' : '' %>>Cikis Niyeti</option>
                          <option value="TIME_ON_PAGE" <%= typeof game !== 'undefined' && game && game.trigger === 'TIME_ON_PAGE' ? 'selected' : '' %>>Zaman</option>
                          <option value="SCROLL_DEPTH" <%= typeof game !== 'undefined' && game && game.trigger === 'SCROLL_DEPTH' ? 'selected' : '' %>>Scroll</option>
                          <option value="PAGE_LOAD" <%= typeof game !== 'undefined' && game && game.trigger === 'PAGE_LOAD' ? 'selected' : '' %>>Sayfa Yuklendiginde</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Deger (ms veya %)</label>
                        <input type="number" class="form-control" id="triggerValue" value="<%= typeof game !== 'undefined' && game ? game.triggerValue : 0 %>">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Icerik -->
                <div class="card mb-4">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="ti ti-text-size me-2"></i>Icerik</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Emoji</label>
                        <input type="text" class="form-control" id="popupEmoji" value="<%= typeof game !== 'undefined' && game && game.config ? (game.config.emoji || '🎁') : '🎁' %>" oninput="updatePreview()">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Baslik</label>
                        <input type="text" class="form-control" id="popupTitle" value="<%= typeof game !== 'undefined' && game && game.config ? (game.config.title || 'Ozel Teklif!') : 'Ozel Teklif!' %>" oninput="updatePreview()">
                      </div>
                      <div class="col-12">
                        <label class="form-label">Alt Baslik</label>
                        <input type="text" class="form-control" id="popupSubtitle" value="<%= typeof game !== 'undefined' && game && game.config ? (game.config.subtitle || 'Ayrilmadan once sana ozel!') : 'Ayrilmadan once sana ozel!' %>" oninput="updatePreview()">
                      </div>
                      <div class="col-12">
                        <label class="form-label">Buton Metni</label>
                        <input type="text" class="form-control" id="popupButton" value="<%= typeof game !== 'undefined' && game && game.config ? (game.config.buttonText || 'Indirimi Al') : 'Indirimi Al' %>" oninput="updatePreview()">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Indirim -->
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="ti ti-discount me-2"></i>Indirim</h5>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Indirim Tipi</label>
                        <select class="form-select" id="discountType" onchange="updatePreview()">
                          <option value="PERCENTAGE" <%= typeof game !== 'undefined' && game && game.segments && game.segments[0] && game.segments[0].type === 'PERCENTAGE' ? 'selected' : '' %>>% Indirim</option>
                          <option value="FIXED_AMOUNT" <%= typeof game !== 'undefined' && game && game.segments && game.segments[0] && game.segments[0].type === 'FIXED_AMOUNT' ? 'selected' : '' %>>Sabit Tutar</option>
                          <option value="FREE_SHIPPING" <%= typeof game !== 'undefined' && game && game.segments && game.segments[0] && game.segments[0].type === 'FREE_SHIPPING' ? 'selected' : '' %>>Ucretsiz Kargo</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Deger</label>
                        <input type="number" class="form-control" id="discountValue" value="<%= typeof game !== 'undefined' && game && game.segments && game.segments[0] ? game.segments[0].value : 10 %>" oninput="updatePreview()">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sag Panel: Onizleme -->
              <div class="col-lg-5">
                <div class="card position-sticky" style="top: 1rem;">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="ti ti-eye me-2"></i>Onizleme</h5>
                  </div>
                  <div class="card-body">
                    <div class="popup-preview">
                      <button class="popup-close">&times;</button>
                      <div class="popup-emoji" id="previewEmoji">🎁</div>
                      <div class="popup-title" id="previewTitle">Ozel Teklif!</div>
                      <div class="popup-subtitle" id="previewSubtitle">Ayrilmadan once sana ozel!</div>
                      <div class="popup-discount" id="previewDiscount">%10</div>
                      <button class="popup-btn" id="previewButton">Indirimi Al</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <%- include('../../partials/footer') %>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/menu.js"></script>
  <script src="/assets/js/app.js"></script>
  <script>
    const gameId = '<%= typeof game !== "undefined" && game ? game.id : "" %>';

    document.addEventListener('DOMContentLoaded', updatePreview);

    function updatePreview() {
      document.getElementById('previewEmoji').textContent = document.getElementById('popupEmoji').value;
      document.getElementById('previewTitle').textContent = document.getElementById('popupTitle').value;
      document.getElementById('previewSubtitle').textContent = document.getElementById('popupSubtitle').value;
      document.getElementById('previewButton').textContent = document.getElementById('popupButton').value;

      const type = document.getElementById('discountType').value;
      const value = document.getElementById('discountValue').value;

      let discountText = '';
      if (type === 'PERCENTAGE') {
        discountText = `%${value}`;
      } else if (type === 'FIXED_AMOUNT') {
        discountText = `${value} TL`;
      } else {
        discountText = 'UCRETSIZ KARGO';
      }
      document.getElementById('previewDiscount').textContent = discountText;
    }

    async function saveGame() {
      const type = document.getElementById('discountType').value;
      const value = parseFloat(document.getElementById('discountValue').value) || 0;

      const data = {
        name: document.getElementById('gameName').value,
        isActive: document.getElementById('gameActive').checked,
        trigger: document.getElementById('triggerType').value,
        triggerValue: parseInt(document.getElementById('triggerValue').value),
        config: {
          emoji: document.getElementById('popupEmoji').value,
          title: document.getElementById('popupTitle').value,
          subtitle: document.getElementById('popupSubtitle').value,
          buttonText: document.getElementById('popupButton').value,
        },
        segments: [{
          label: type === 'PERCENTAGE' ? `%${value} Indirim` : type === 'FREE_SHIPPING' ? 'Ucretsiz Kargo' : `${value} TL Indirim`,
          type: type,
          value: value,
          probability: 1.0,
          color: '#7367f0',
        }],
      };

      try {
        if (gameId) {
          await Games.save(gameId, 'POPUP', data);
        } else {
          await api.post('/api/games', { ...data, type: 'POPUP' });
          showToast('Oyun olusturuldu!', 'success');
        }
      } catch (error) {
        console.error(error);
      }
    }
  </script>
</body>
</html>

